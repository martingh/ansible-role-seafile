---
- name: "Fetch seahub_settings.py generated by setup"
  slurp:
    src: '{{ seafile_conf_dir + "/seahub_settings.py" }}'
  register: seahub_settings_file

- name: "Read SECRET_KEY"
  set_fact: 
    _seafile_seahub_settings_secret_key: "{{ seahub_settings_file['content'] | b64decode | regex_findall('SECRET_KEY = \"(.+)\"') | first }}"
    
- name: provision / rewrite configuration files and scripts
  become:               yes
  become_user:          '{{ seafile_user }}'
  template:
    src:                '{{ item.src }}'
    dest:               '{{ item.dest }}'
    owner:              '{{ seafile_user }}'
    group:              '{{ seafile_user }}'
    mode:               '{{ item.exec | default(false) | ternary(0750,0640) }}'
  with_items:
    - src:              'conf/ccnet.conf'
      dest:             '{{ seafile_conf_dir }}/'
    - src:              'conf/seafile.conf'
      dest:             '{{ seafile_conf_dir }}/'
    - src:              'conf/seafdav.conf'
      dest:             '{{ seafile_conf_dir }}/'
    - src:              'conf/seahub_settings.py'
      dest:             '{{ seafile_conf_dir }}/'
    - src:              'conf/gunicorn.conf.py'
      dest:             '{{ seafile_conf_dir }}/'
